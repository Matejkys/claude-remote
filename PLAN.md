# Claude Remote - Implementation Plan

## Context

Claude Code (CC) running in tmux gets blocked when it needs user input (permission prompt, question, task completion) and the user is away from the MacBook. The current `osascript` notification hook is local-only and invisible from iPhone.

**Goal:** macOS menu bar app that detects user presence and routes CC notifications either locally (at computer) or to Telegram (away), with bidirectional Telegram communication to unblock CC remotely from iPhone.

**Existing hook in `~/.claude/settings.json`:** Notification hook with `osascript` - will be replaced.

---

## Architecture

```
                                         â”Œâ”€ Present â†’ macOS UserNotification
CC hook â†’ notify-hook.sh â†’ SwiftUI App â”€â”€â”¤
                                         â””â”€ Away â†’ TelegramService â†’ iPhone push
                                                       â†‘
iPhone Telegram â†’ Node.js Relay â†’ tmux send-keys â†’ CC gets input
```

Two components:
- **ClaudeRemote (SwiftUI menu bar app)** - presence detection, notification routing, configuration UI, Telegram setup
- **telegram-relay (Node.js)** - Telegram polling for incoming replies, tmux interaction

Swift for native macOS APIs (IOKit, NSWorkspace, UserNotifications, Keychain). Node.js for Telegram bot ecosystem + shell interaction. App is NOT sandboxed (personal tool, no App Store distribution) - required for `IOHIDSystem` idle time access.

---

## Project Structure

```
~/Development/tools/claude-remote/
â”œâ”€â”€ ClaudeRemote/                         # Xcode project - macOS SwiftUI app
â”‚   â”œâ”€â”€ ClaudeRemoteApp.swift             # MenuBarExtra entry point, LSUIElement=true
â”‚   â”œâ”€â”€ MenuBarView.swift                 # Popover UI
â”‚   â”œâ”€â”€ Models/
â”‚   â”‚   â”œâ”€â”€ AppState.swift                # @Observable state (isAway, settings)
â”‚   â”‚   â””â”€â”€ NotificationPayload.swift     # CC hook JSON model
â”‚   â”œâ”€â”€ Services/
â”‚   â”‚   â”œâ”€â”€ PresenceDetector.swift        # Idle time, screen lock, display sleep
â”‚   â”‚   â”œâ”€â”€ NotificationRouter.swift      # Routes to local or Telegram
â”‚   â”‚   â”œâ”€â”€ TelegramService.swift         # Telegram Bot API sendMessage
â”‚   â”‚   â”œâ”€â”€ LocalNotifier.swift           # UNUserNotificationCenter
â”‚   â”‚   â””â”€â”€ HTTPListener.swift            # NWListener on 127.0.0.1:7677
â”‚   â””â”€â”€ Config/
â”‚       â””â”€â”€ Settings.swift                # UserDefaults + Keychain, writes .env for relay
â”‚
â”œâ”€â”€ telegram-relay/                       # Node.js TypeScript
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ bot.ts                        # Telegram long-polling, command handling
â”‚   â”‚   â”œâ”€â”€ tmux.ts                       # send-keys, capture-pane, state checking
â”‚   â”‚   â””â”€â”€ config.ts                     # Reads .env
â”‚   â”œâ”€â”€ package.json
â”‚   â””â”€â”€ tsconfig.json
â”‚
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ notify-hook.sh                    # CC hook â†’ HTTP POST to SwiftUI app
â””â”€â”€ .env                                  # Generated by SwiftUI app (gitignored)
```

---

## Implementation Steps

### Step 1: Telegram bot creation (manual, one-time)

- @BotFather â†’ `/newbot` â†’ get bot token
- @userinfobot â†’ get numeric Telegram user ID

### Step 2: SwiftUI Menu Bar App

**ClaudeRemoteApp.swift:**
- `MenuBarExtra` with popover (icon changes color: green=present, orange=away)
- `LSUIElement = true` (no Dock icon)
- Launch at login via `SMAppService.mainApp`

**PresenceDetector.swift:**
- `IOHIDSystem` HIDIdleTime via IOKit (polled every 30s)
- `DistributedNotificationCenter`: `com.apple.screenIsLocked` / `com.apple.screenIsUnlocked`
- `NSWorkspace.shared.notificationCenter`: `screensDidSleepNotification` / `screensDidWakeNotification`
- Manual toggle override
- Publishes `@Published var isAway: Bool` â€” true when ANY: idle > threshold OR screen locked OR display sleep OR manual toggle

**HTTPListener.swift:**
- `NWListener` (Network framework) on `127.0.0.1:7677`
- `POST /notify` â€” receives CC hook JSON, validates shared secret from `Authorization` header
- Passes parsed `NotificationPayload` to `NotificationRouter`

**NotificationRouter.swift:**
- `isAway == false` â†’ `LocalNotifier.send(payload)`
- `isAway == true` â†’ `TelegramService.send(payload)`

**LocalNotifier.swift:**
- `UNUserNotificationCenter` for native macOS notifications
- Notification actions for permission prompts (Approve/Deny buttons)

**TelegramService.swift:**
- `URLSession` POST to `https://api.telegram.org/bot{token}/sendMessage`
- Bot token from Keychain (`Security` framework)
- Messages include **structured hook data + terminal context** (last 20 lines from tmux capture-pane)
- Message formatting by event type:

  **Permission prompt:**
  ```
  ğŸ” Permission Request

  Tool: Bash
  Command: npm install express

  â”€â”€â”€ Terminal Context â”€â”€â”€
  > Installing dependencies for the new API module.
  > I need to run npm install to add express.
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  /y to approve Â· /n to deny
  ```

  **AskUserQuestion / elicitation:**
  ```
  ğŸ’¬ Claude is asking:

  â”€â”€â”€ Terminal Context â”€â”€â”€
  Which database should we use?

  1. PostgreSQL (Recommended)
  2. MySQL
  3. SQLite
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  Reply /select 1, /select 2, etc. or type answer
  ```

  **Stop (CC finished):**
  ```
  âœ… Claude finished

  â”€â”€â”€ Terminal Context â”€â”€â”€
  > All tests passing. Refactoring complete.
  > Updated 3 files, added 2 tests.
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  Send next prompt or /status for full view
  ```

- On-demand screenshot: `/screenshot` command in relay renders terminal to image via `tmux capture-pane` + ANSI-to-image conversion and sends as Telegram photo

**Settings.swift (single source of truth):**
- UserDefaults for: idle threshold, detection toggles, notification preferences
- Keychain for: Telegram bot token, shared HTTP secret
- On save: writes `.env` file for telegram-relay with `TELEGRAM_BOT_TOKEN`, `TELEGRAM_USER_ID`, `TMUX_SESSION_NAME`, `HTTP_SECRET`

### Step 3: Menu Bar UI

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Status: ğŸŸ¢ At computer          â”‚
â”‚                                  â”‚
â”‚  â”€â”€ Presence Detection â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚  â— Automatic                     â”‚
â”‚     Idle threshold: [5 min â–¾]    â”‚
â”‚     â˜‘ Screen lock = away         â”‚
â”‚     â˜‘ Display sleep = away       â”‚
â”‚  â—‹ Manual                        â”‚
â”‚     [ ] I'm away                 â”‚
â”‚                                  â”‚
â”‚  â”€â”€ Notifications â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚  When at computer:               â”‚
â”‚     â˜‘ macOS notification         â”‚
â”‚     â˜ Sound                      â”‚
â”‚  When away:                      â”‚
â”‚     â˜‘ Telegram                   â”‚
â”‚     â˜‘ macOS notification         â”‚
â”‚                                  â”‚
â”‚  â”€â”€ Telegram â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚  Status: âœ“ Connected             â”‚
â”‚  Bot: @my_claude_bot             â”‚
â”‚  [ Configure... ]                â”‚
â”‚                                  â”‚
â”‚  â”€â”€ Claude Code â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚  tmux session: claude            â”‚
â”‚  CC Status: â— Running            â”‚
â”‚  Relay: â— Running                â”‚
â”‚                                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚  â˜‘ Launch at login               â”‚
â”‚  Quit Claude Remote              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Step 4: Telegram Relay (Node.js)

**config.ts:** Reads `.env` (written by SwiftUI app). Fails fast if missing required vars.

**tmux.ts:**
- `sendKeys(paneId, text)` â€” sanitized: wraps input in single quotes, escapes embedded quotes. Uses `tmux send-keys -t {paneId} -- '{sanitized}' Enter`
- `capturePane(paneId, lines?)` â€” `tmux capture-pane -t {paneId} -p -S -{lines}`
- `isWaitingForInput(paneId)` â€” captures last lines, checks for known CC prompt patterns (permission prompt, input prompt, idle state)
- `isSessionActive(session)` â€” `tmux has-session -t {session}`

**bot.ts:**
- Long-polling for Telegram messages
- Security: whitelist `TELEGRAM_USER_ID`, silently ignore others
- **Dynamic pane targeting:** on every reply, relay scans all panes in the tmux session:
  1. `tmux list-panes -t {session}` â†’ get all pane IDs
  2. For each pane, call `isWaitingForInput(paneId)`
  3. If exactly 1 pane waiting â†’ send input there
  4. If 0 panes waiting â†’ reply "CC is not waiting for input"
  5. If 2+ panes waiting â†’ reply with list of waiting panes, ask user to specify via `/pane <id> <text>`
- **State-aware input:** always checks before injecting, never sends blindly
- Commands:
  - `/y` or `/yes` â†’ sends "y" to waiting pane (quick permission approve)
  - `/n` or `/no` â†’ sends "n" to waiting pane (quick permission deny)
  - `/select <N>` â†’ sends number for AskUserQuestion prompts
  - `/pane <id> <text>` â†’ sends text to specific pane (for multi-pane disambiguation)
  - `/status` â†’ `capturePane` â†’ sends last 50 lines as Telegram text message
  - `/screenshot` â†’ captures terminal, converts ANSI to PNG (via `ansi-to-image` or `svg-term-cli` + sharp), sends as Telegram photo
  - `/sessions` â†’ lists active tmux sessions
  - Free text â†’ sanitized `sendKeys` to the single waiting pane (only if exactly 1 is waiting)

### Step 5: Hook Script (`scripts/notify-hook.sh`)

```bash
#!/bin/bash
# Reads CC hook JSON from stdin, adds tmux pane context + terminal snapshot, forwards to app
INPUT=$(cat)
PANE_ID="${TMUX_PANE:-}"
# Capture last 20 lines of terminal for context in Telegram messages
CONTEXT=$(tmux capture-pane -t "$PANE_ID" -p -S -20 2>/dev/null)
ENRICHED=$(echo "$INPUT" | jq \
  --arg pane "$PANE_ID" \
  --arg ctx "$CONTEXT" \
  '. + {tmux_pane: $pane, terminal_context: $ctx}')
curl -s -X POST http://127.0.0.1:7677/notify \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $(cat ~/.claude-remote-secret 2>/dev/null)" \
  -d "$ENRICHED" &>/dev/null &
```

### Step 6: tmux launcher (`cy` shell function)

Update `~/.zshrc` â€” replace existing `cy` alias with a function that ensures CC always runs inside a tmux session named `claude`:

```bash
# Launch Claude Code in tmux (required for claude-remote relay)
cy() {
  local session="claude"
  if tmux has-session -t "$session" 2>/dev/null; then
    # Session exists â€” attach to it
    tmux attach-session -t "$session"
  else
    # Create new tmux session and run CC in it
    tmux new-session -s "$session" -- claude --chrome --dangerously-skip-permissions
  fi
}
```

Existing `cc` alias (`claude --chrome`) remains unchanged â€” for quick local usage without tmux.

### Step 7: Claude Code hooks configuration

Update `~/.claude/settings.json` â€” replace existing Notification hook, add Stop hook:

```json
{
  "hooks": {
    "Notification": [{
      "matcher": "",
      "hooks": [{
        "type": "command",
        "command": "~/Development/tools/claude-remote/scripts/notify-hook.sh"
      }]
    }],
    "Stop": [{
      "hooks": [{
        "type": "command",
        "command": "~/Development/tools/claude-remote/scripts/notify-hook.sh"
      }]
    }]
  }
}
```

Existing PostToolUse hooks (Python/TS validation) remain unchanged.

### Step 8: Auto-start

- **SwiftUI app:** `SMAppService.mainApp` (built-in Launch at login)
- **Node.js relay:** macOS app manages relay lifecycle â€” starts relay process on app launch, stops on quit. Falls back to `~/Library/LaunchAgents/com.claude-remote.relay.plist` if app is not running.

---

## Security

- **tmux injection protection:** All text input sanitized (single-quote wrapped, embedded quotes escaped). State-aware â€” relay verifies CC is waiting for input before sending keys.
- **Authenticated HTTP listener:** Shared secret generated by SwiftUI app, stored in Keychain + written to `~/.claude-remote-secret`. Hook script includes it in `Authorization` header. Listener rejects requests without valid secret.
- **Telegram auth:** User ID whitelist â€” both app and relay ignore messages from other senders.
- **Localhost only:** HTTP listener bound to `127.0.0.1:7677` (no external access).
- **No sensitive data in transit:** Only event metadata (type, tool name) sent via Telegram. `/status` command explicitly documented as potentially exposing terminal content.
- **Secrets:** Bot token in Keychain (Swift) + `.env` (Node.js, gitignored). No hardcoded values.
- **Secret file permissions:** `~/.claude-remote-secret` created with `chmod 600` (owner read/write only).

---

## Verification

1. Build and launch ClaudeRemote â†’ appears in menu bar with green icon
2. Configure Telegram bot via app UI â†’ status shows "Connected"
3. Start CC in tmux: `cy` (uses the shell function from Step 6)
4. Start relay (or verify app auto-started it)
5. **Local notification test:** CC hits permission prompt at computer â†’ macOS notification with Approve/Deny buttons
6. **Away detection test:** Lock screen â†’ icon turns orange â†’ CC hits prompt â†’ Telegram push on iPhone
7. **Reply test:** Reply `/y` in Telegram â†’ CC continues
8. **Free text test:** CC asks question â†’ reply with text in Telegram â†’ CC receives input
9. **State safety test:** Send random text when CC is NOT waiting â†’ bot replies "CC is not waiting for input"
10. **Pane targeting test:** Run 2 CC sessions in different tmux panes â†’ verify notifications route replies to correct pane
11. **Status test:** `/status` in Telegram â†’ see current terminal state
12. **Return test:** Unlock screen â†’ icon turns green â†’ next notification goes to macOS, not Telegram
